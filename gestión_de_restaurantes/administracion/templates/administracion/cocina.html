<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos en cocina</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Pedidos Pendientes, en Proceso, Entregados y Pendientes de Pago</h1>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Mesa</th>
                    <th>Item</th>
                    <th>Cantidad</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for orden in ordenes %}
                <tr id="orden-{{ orden.id }}">
                    <td>{{ orden.mesa.numero }}</td>
                    <td>{{ orden.item.nombre }}</td>
                    <td>{{ orden.cantidad }}</td>
                    <td id="estado-{{ orden.id }}">{{ orden.estado }}</td>
                    <td>
                        {% if orden.estado == 'PENDIENTE' %}
                            <button class="btn btn-warning btn-sm" onclick="cambiarEstado({{ orden.id }}, 'EN_PROCESO')">Marcar como En Proceso</button>
                        {% elif orden.estado == 'EN PROCESO' %}
                            <button class="btn btn-info btn-sm" onclick="cambiarEstado({{ orden.id }}, 'ENTREGADO')">Marcar como Entregado</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
 <!-- Javascript para que no se refresque la pagina cuando tocas el boton de en proceso-->
   <script>
        function cambiarEstado(ventaId, nuevoEstado) {
            const url = `/administracion/cambiar-estado-venta-ajax/${ventaId}/${nuevoEstado}/`;
    
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}', // Asegúrate de incluir el token CSRF
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`estado-${ventaId}`).innerText = data.nuevo_estado;
                    // Cambiar el botón basado en el nuevo estado
                    let button = document.querySelector(`#orden-${ventaId} button`);
                    if (data.nuevo_estado === 'EN_PROCESO') {
                        button.innerText = 'Marcar como Entregado';
                        button.classList.remove('btn-warning');
                        button.classList.add('btn-info');
                        button.setAttribute('onclick', `cambiarEstado(${ventaId}, 'ENTREGADO')`);
                    } else if (data.nuevo_estado === 'ENTREGADO') {
                        button.remove(); // Remover el botón si no hay más acciones disponibles
                    }
                } else {
                    alert('No se pudo cambiar el estado');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script> 
    
</body>
</html>